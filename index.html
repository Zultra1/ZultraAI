<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zultra AI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root { --bg: #f0f2f5; --side: #fff; --txt: #333; --sub: #777; --acc: #e056fd; --bord: #e0e0e0; --ai-bg: #fff; --u-bg: #e056fd; }
        body.dark-mode { --bg: #121212; --side: #1e1e1e; --txt: #fff; --sub: #aaa; --acc: #e056fd; --bord: #333; --ai-bg: #2f2f2f; --u-bg: #e056fd; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; transition: 0.3s; }
        body { background: var(--bg); color: var(--txt); height: 100vh; display: flex; overflow: hidden; }

        /* LAYOUT */
        .sidebar { width: 260px; background: var(--side); border-right: 1px solid var(--bord); display: flex; flex-direction: column; padding: 24px; z-index: 2; }
        .main { flex: 1; display: flex; flex-direction: column; background: var(--bg); position: relative; }

        /* UI */
        .title { font-size: 1.5rem; font-weight: 800; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .btn-new { background: var(--acc); color: white; border: none; padding: 12px; border-radius: 8px; width: 100%; cursor: pointer; font-weight: bold; margin-bottom: 20px; }
        .nav-item { padding: 12px; cursor: pointer; color: var(--sub); display: flex; align-items: center; gap: 10px; margin-top: auto; }
        .nav-item:hover { color: var(--txt); background: rgba(0,0,0,0.05); border-radius: 8px; }

        /* CHAT */
        .chat-box { flex: 1; overflow-y: auto; padding: 20px 40px; display: flex; flex-direction: column; gap: 20px; }
        .msg { display: flex; gap: 15px; max-width: 800px; margin: 0 auto; width: 100%; }
        .msg.user { flex-direction: row-reverse; }
        .avatar { width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: var(--sub); color: white; flex-shrink: 0; }
        .avatar.user { background: var(--acc); }
        .bubble { padding: 15px 20px; border-radius: 12px; background: var(--ai-bg); box-shadow: 0 2px 5px rgba(0,0,0,0.05); color: var(--txt); max-width: 80%; line-height: 1.5; }
        .bubble.user { background: var(--u-bg); color: white; }
        
        /* INPUT */
        .input-area { padding: 20px; background: var(--side); border-top: 1px solid var(--bord); display: flex; justify-content: center; }
        .input-wrap { max-width: 800px; width: 100%; display: flex; gap: 10px; background: var(--bg); padding: 10px 15px; border-radius: 25px; border: 1px solid var(--bord); align-items: center; }
        .chat-input { flex: 1; background: transparent; border: none; outline: none; color: var(--txt); font-size: 1rem; }
        .send-btn { background: var(--acc); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; }

        /* OVERLAY */
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .card { background: var(--side); padding: 40px; border-radius: 16px; border: 1px solid var(--bord); text-align: center; max-width: 400px; width: 90%; }
        .btn-p { background: var(--acc); color: white; padding: 10px; border-radius: 8px; border: none; cursor: pointer; width: 100%; margin-top: 10px; }
        .btn-s { background: transparent; border: 1px solid var(--sub); color: var(--sub); padding: 8px; border-radius: 20px; margin-top: 10px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="overlay">
        <div id="loading-ui" style="text-align:center">
            <h3>Connecting...</h3>
            <p id="status" style="color:var(--sub); margin-bottom:20px;">Checking Configuration</p>
            <button class="btn-s" onclick="forceLogout()">Reset / Force Logout</button>
            <button class="btn-s" onclick="showLogin()">Force Login</button>
        </div>

        <div id="login-ui" style="display:none;" class="card">
            <h2>Zultra AI</h2>
            <p style="margin-bottom:15px; color:var(--sub)">Login Required</p>
            <input id="email" type="email" placeholder="Email" style="width:100%; padding:10px; margin-bottom:10px;">
            <input id="pass" type="password" placeholder="Password" style="width:100%; padding:10px; margin-bottom:10px;">
            <button class="btn-p" onclick="doLogin()">Log In</button>
            <div id="login-err" style="color:red; margin-top:10px; font-size:0.9rem;"></div>
        </div>

        <div id="missing-ui" style="display:none;" class="card">
            <h2>API Key Missing</h2>
            <p style="margin:15px 0; color:var(--sub)">Please go to Zultra Cloud and save your key.</p>
            <button class="btn-p" onclick="window.location.href='cloud.html'">Go to Cloud App</button>
            <button class="btn-s" onclick="window.location.reload()">Refresh</button>
        </div>
    </div>

    <div class="sidebar">
        <div class="title"><i class="fas fa-brain" style="color:var(--acc)"></i> Zultra AI</div>
        <button class="btn-new" onclick="clearChat()">+ New Chat</button>
        <div style="flex:1"></div>
        <div class="nav-item" onclick="toggleTheme()"><i class="fas fa-moon"></i> Theme</div>
        <div class="nav-item" onclick="window.location.href='cloud.html'"><i class="fas fa-cloud"></i> Account</div>
        <div class="nav-item" onclick="forceLogout()" style="color:red"><i class="fas fa-sign-out-alt"></i> Logout</div>
    </div>

    <div class="main">
        <div class="chat-box" id="chat">
            <div class="msg">
                <div class="avatar"><i class="fas fa-robot"></i></div>
                <div class="bubble">Hello! I am connected to <b>Gemini 2.0 Flash</b>. How can I help?</div>
            </div>
        </div>
        <div class="input-area">
            <div class="input-wrap">
                <input type="text" class="chat-input" id="inp" placeholder="Message..." onkeypress="if(event.key==='Enter') send()">
                <button class="send-btn" id="btn" onclick="send()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBqhm6v1epzDxuMGYhd-7t_FPS-1ugF6sc",
            authDomain: "zultra-media-player.firebaseapp.com",
            projectId: "zultra-media-player",
            storageBucket: "zultra-media-player.firebasestorage.app",
            messagingSenderId: "1089626227358",
            appId: "1:1089626227358:web:04721377413acf100cf18f",
            measurementId: "G-YKLDV9NRSC"
        };

        // SAFETY INIT
        let auth, db, apiKey, user;
        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            
            auth.onAuthStateChanged(u => {
                if (u) {
                    user = u;
                    document.getElementById('status').innerText = "Loading API Key...";
                    loadKey();
                } else {
                    showLogin();
                }
            });
        } catch(e) {
            alert("Firebase Error: " + e.message);
        }

        function showLogin() {
            document.getElementById('loading-ui').style.display = 'none';
            document.getElementById('login-ui').style.display = 'block';
        }

        function doLogin() {
            const e = document.getElementById('email').value;
            const p = document.getElementById('pass').value;
            auth.signInWithEmailAndPassword(e, p).catch(err => {
                document.getElementById('login-err').innerText = err.message;
            });
        }

        function forceLogout() {
            auth.signOut().then(() => window.location.reload());
        }

        function loadKey() {
            db.collection('users').doc(user.uid).get().then(doc => {
                if (doc.exists && doc.data().gemini_api_key) {
                    apiKey = doc.data().gemini_api_key;
                    document.getElementById('overlay').style.display = 'none';
                } else {
                    document.getElementById('loading-ui').style.display = 'none';
                    document.getElementById('missing-ui').style.display = 'block';
                }
            }).catch(e => {
                document.getElementById('status').innerText = "DB Error: " + e.message;
            });
        }

        // CHAT LOGIC
        async function send() {
            const inp = document.getElementById('inp');
            const text = inp.value.trim();
            // *** HERE IS THE FIX: Using a model from your JSON list ***
            const model = "gemini-2.0-flash"; 

            if(!text) return;
            if(!apiKey) return alert("No API Key");

            addMsg(text, 'user');
            inp.value = '';
            
            const btn = document.getElementById('btn');
            btn.disabled = true;
            const loadId = addMsg("...", 'ai', true);

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: text }] }] })
                });

                const data = await response.json();
                document.getElementById(loadId).remove();

                if(data.error) {
                    addMsg("API Error: " + data.error.message, 'ai');
                } else if (data.candidates) {
                    addMsg(data.candidates[0].content.parts[0].text, 'ai');
                } else {
                    addMsg("No response content.", 'ai');
                }
            } catch(e) {
                document.getElementById(loadId).remove();
                addMsg("Net Error: " + e.message, 'ai');
            }
            btn.disabled = false;
            setTimeout(() => inp.focus(), 100);
        }

        function addMsg(text, type, isTemp) {
            const box = document.getElementById('chat');
            const div = document.createElement('div');
            const id = 'm-' + Date.now();
            div.id = id;
            div.className = `msg ${type}`;
            
            const content = (type === 'ai' && !isTemp) ? marked.parse(text) : text;
            const ico = type === 'ai' ? '<i class="fas fa-robot"></i>' : '<i class="fas fa-user"></i>';
            const bub = type === 'ai' ? 'bubble' : 'bubble user';

            div.innerHTML = `<div class="avatar ${type}">${ico}</div><div class="${bub}">${content}</div>`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            return id;
        }

        function clearChat() {
            document.getElementById('chat').innerHTML = `<div class="msg"><div class="avatar"><i class="fas fa-robot"></i></div><div class="bubble">Chat cleared. Using Gemini 2.0 Flash.</div></div>`;
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        }
        if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');

    </script>
</body>
</html>
